# Usage:
#   1. Copy .env.example to .env and set CONNECTION_STRING_MYDB to your real SQL Server (keep .env secret).
#   2. Run: docker compose up -d
#   Optional local DB: docker compose --profile with-db up -d
services:
  # Optional: local SQL Server (only if not using a real/external server)
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    profiles:
      - with-db
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${MSSQL_SA_PASSWORD}
      - MSSQL_PID=${MSSQL_PID}
    ports:
      - "${DB_PORT:-1433}:1433"
    volumes:
      - db_data:/var/opt/mssql
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P ${MSSQL_SA_PASSWORD} -Q "SELECT 1" -C || exit 1
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

  # Backend API — connection string from env (keep secret in .env, never commit)
  api:
    build: ./backend_cs_recipes
    ports:
      - "${API_PORT_HTTP:-5244}:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - ASPNETCORE_URLS=http://+:80
      # Set in .env: CONNECTION_STRING_MYDB=Server=...;Database=Recipes;User Id=...;Password=...;TrustServerCertificate=True;...
      - ConnectionStrings__MyDB=${CONNECTION_STRING_MYDB}
    volumes:
      - ./backend_cs_recipes/Webapi/Images:/app/Images
    restart: unless-stopped

  # Frontend Web Service (Angular SSR) — entry: dist/my-project/server/main.js
  web:
    build: ./fronted_recipes/my-project
    environment:
      - NODE_ENV=production
      - PORT=${FRONTEND_PORT:-4200}
      - API_PROXY_TARGET=http://api:80
    ports:
      - "${FRONTEND_PORT:-4200}:${FRONTEND_PORT:-4200}"
    depends_on:
      - api
    restart: unless-stopped

volumes:
  db_data: